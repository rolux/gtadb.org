<!DOCTYPE html>
    <html lang="en">
    <head>
        <title>GTA VI Landmarks Map</title>
        <meta charset="utf-8"/>
        <link rel="icon" href="gta6map.png"/>
        <style>
            html, body {
                background: rgb(0, 0, 0);
                font-family: sans-serif;
                font-size: 11px;
                height: 100%;
                margin: 0;
                overflow: hidden;
                padding: 0;
                width: 100%;
            }
            a {
                color: rgb(0, 0, 0);
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
            }
            input[type="text"] {
                all: unset;
                appearance: none;
                -moz-appearance: none;
                -ms-appearance: none;
                -webkit-appearance: none;
                background-color: transparent;
                border: 1px solid transparent;
                box-sizing: border-box;
                font-family: sans-serif;
                font-size: 12px;
                height: 18px;
                margin: 0;
                padding: 2px 4px;
                position: absolute;
            }
            input[type="text"]:focus {
                border: 1px solid rgb(192, 192, 192);
                outline: none;
            }
            input[type="text"]::placeholder {
                color: rgb(128, 128, 128)
            }
            select {
                all: unset;
                appearance: none;
                -moz-appearance: none;
                -ms-appearance: none;
                -webkit-appearance: none;
                background: transparent;
                background-image: none;
                border: 1px solid transparent;
                border-radius: 4px;
                box-sizing: border-box;
                color: inherit;
                cursor: pointer;
                font: inherit;
                font-family: sans-serif;
                font-size: 12px;
                margin: 0;
                padding: 2px 4px;
                text-overflow: ellipsis;
            }
            select:focus {
                outline: none;
            }
            select::-ms-expand {
                display: none
            }
            #map, #canvas, #markers {
                bottom: 0;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
            }
            #map {
                cursor: default;
                inset: 0;
            }
            #map.dragging {
                cursor: grabbing;
            }
            #canvas {
                filter: saturate(0.2);
                user-select: none;
            }
            .marker {
                background-color: rgb(192, 192, 192);
                border: 1px solid rgb(255, 255, 255);
                border-radius: 8px 8px 0 8px;
                cursor: pointer;
                display: none;
                height: 14px;
                left: 50%;
                margin-left: -8px;
                margin-top: -19.314px;
                position: absolute;
                top: 50%;
                transform: rotate(45deg);
                width: 14px;
                z-index: 100;
            }
            .marker.selected {
                border: 2.5px solid rgb(255, 255, 255);
                height: 11px;
                width: 11px;
                z-index: 101;
            }
            .marker.dragging {
                border: 2px solid rgb(128, 128,128);
            }
            .marker.agriculture {
                background-color: rgb(192, 192, 0);
            }
            .marker.commercial {
                background-color: rgb(0, 0, 255);
            }
            .marker.entertainment {
                background-color: rgb(255, 128, 0);
            }
            .marker.government {
                background-color: rgb(255, 0, 0);
            }
            .marker.hotel {
                background-color: rgb(0, 255, 255);
            }
            .marker.infrastructure {
                background-color: rgb(128, 128, 128);
            }
            .marker.industrial {
                background-color: rgb(255, 255, 0);
            }
            .marker.monument {
                background-color: rgb(128, 0, 0);
            }
            .marker.other {
                background-color: rgb(240, 240, 240);
            }
            .marker.public {
                background-color: rgb(255, 0, 255);
            }
            .marker.nature {
                background-color: rgb(0, 128, 0);
            }
            .marker.residential {
                background-color: rgb(0, 255, 0);
            }
            .marker.transport {
                background-color: rgb(192, 192, 192);
            }
            .panel {
                background-color: rgba(255, 255, 255, 0.75);
                bottom: 0;
                position: absolute;
                top: 0;
                width: 256px;
                z-index: 1000;
            }
            #listPanel {
                left: 0;
            }
            #titleBar {
                border-bottom: 1px solid rgba(0, 0, 0, 0.125);
                height: 31px;
                left: 0;
                position: absolute;
                top: 0;
                width: 256px
            }
            #titleBar #titleElement {
                font-size: 12px;
                font-weight: bold;
                left: 8px;
                padding: 2px 4px;
                position: absolute;
                top: 7px;
                width: 192px;
            }
            #findBar {
                border-bottom: 1px solid rgba(0, 0, 0, 0.125);
                height: 31px;
                left: 0;
                position: absolute;
                top: 32px;
                width: 256px
            }
            #findBar input {
                left: 8px;
                position: absolute;
                top: 7px;
                width: 192px;
            }
            #filterBar {
                border-bottom: 1px solid rgba(0, 0, 0, 0.125);
                height: 31px;
                left: 0;
                position: absolute;
                top: 64px;
                width: 256px
            }
            #filterBar select {
                width: 192px
            }
            .aboutButton, .clearButton, .closeButton {
                cursor: pointer;
                font-size: 11px;
                height: 12px;
                position: absolute;
                right: 8px;
                top: 9px;
                user-select: none;
            }
            .clearButton {
                display: none;
            }
            #sortBar {
                border-bottom: 1px solid rgba(0, 0, 0, 0.125);
                height: 31px;
                left: 0;
                position: absolute;
                top: 96px;
                width: 256px
            }
            #filterBar select, #sortBar select {
                left: 8px;
                position: absolute;
                top: 6px;
                white-space: nowrap;
                width: 192px;
            }
            #listBody {
                bottom: 32px;
                left: 0;
                overflow-y: scroll;
                position: absolute;
                top: 128px;
                width: 256px;
            }
            #listBody > .item {
                border-left: 8px solid transparent;
                cursor: pointer;
                height: 32px;
                width: 248px;
            }
            #listBody > .item.selected {
                background-color: rgb(255, 255, 255);
            }
            #listBody > .item div {
                overflow-x: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #listBody > .item .ig {
                font-size: 11px;
                font-weight: bold;
                height: 13px;
                left: 8px;
                padding: 4px 8px 1px 8px;
                top: 0;
                width: 232px;
            }
            #listBody > .item .irl {
                bottom: 0;
                font-size: 9px;
                height: 11px;
                left: 8px;
                padding: 1px 8px 2px 8px;
                width: 232px;
            }
            #statusBar {
                border-top: 1px solid rgba(0, 0, 0, 0.125);
                bottom: 0;
                height: 12px;
                left: 0;
                padding: 10px 8px;
                position: absolute;
                width: 240px;
            }
            #itemPanel {
                display: none;
                font-size: 13px;
                right: 0
            }
            #itemBar {
                border-bottom: 1px solid rgba(0, 0, 0, 0.125);
                height: 31px;
                right: 0;
                position: absolute;
                top: 0;
                width: 256px
            }
            #itemId {
                font-size: 13px;
                left: 10px;
                position: absolute;
                top: 8px;
            }
            #itemBody {
                bottom: 0;
                left: 0;
                overflow-y: scroll;
                position: absolute;
                top: 32px;
                width: 256px;
            }
            #itemBody > div {
                float: left;
                height: fit-content;
                width: 232px;
            }
            #itemIg, #itemIrl {
                border-right: 8px solid transparent;
                height: fit-content;
                padding: 8px;
            }
            #itemBody > div.photo {
                background-color: rgba(0, 0, 0, 0.25);
                height: 144px;
                width: 256px;
            }
            #itemBody > div.photo > img {
                cursor: pointer;
                width: 256px;
            }
            #itemBody > div > div {
                float: left;
                margin: 2px 2px;
                width: 224px;
            }
            #itemBody > div > div.name {
                font-size: 15px;
                font-weight: bold;
                margin-top: 0;
            }
            #itemBody > div > div.coordinates {
                font-size: 11px;
                margin-bottom: 0;
            }
            itemBody > div > div.coordinates > a,
            #itemBody > div > div.coordinates > span.link {
                cursor: pointer;
            }
            #itemBody > div > div.coordinates > a:hover,
            #itemBody > div > div.coordinates > span.link:hover {
                text-decoration: underline
            }
            #itemTags {
                float: left;
                font-size: 11px;
                margin: 8px 8px 2px 8px;
                text-transform: uppercase;
            }
            #itemStatus {
                float: left;
                font-size: 11px;
                margin: 2px 8px 2px 8px;
                text-transform: uppercase;
            }
            #itemEdited {
                float: left;
                font-size: 11px;
                padding: 2px 8px 8px 8px;
                text-transform: uppercase;
            }
            #dialogLayer {
                align-items: center;
                background-color: rgba(0, 0, 0, 0.25);
                bottom: 0;
                display: none;
                justify-content: center;
                left: 0;
                position: absolute;
                right: 0;
                top: 0;
                z-index: 1001;
            }
            .dialog {
                display: none;
            }
            .dialog .bar {
                background-color: rgba(255, 255, 255, 0.75);
                border-radius: 8px 8px 0 0;
                height: 32px;
            }
            .dialog .bar .title {
                float: left;
                font-size: 13px;
                font-weight: bold;
                height: 16px;
                margin: 8px 8px;
                left: 0;
                overflow-x: hidden;
                top: 0;
            }
            .dialog .bar .button {
                cursor: pointer;
                float: left;
                font-size: 11px;
                height: 12px;
                margin: 10px 0;
                right: 0;
                text-align: center;
                top: 0;
                width: 64px;
                user-select: none;
            }
            .dialog .content {
                border-radius: 0 0 8px 8px;
            }
            #aboutDialog {
                width: 640px;
                height: 480px;
            }
            #aboutDialog .bar .title {
                width: 560px;
            }
            #aboutDialog .content {
                background-color: rgba(255, 255, 255, 0.75);
                height: 448px;
            }
            #aboutDialog .content img {
                height: 256px;
                margin: 96px 192px;
                width: 256px;
            }
            #photoDialog .bar .title {
                width: 944px;
            }
            #photoDialog .content img {
                border-radius: 0 0 8px 8px;
                user-select: none;
            }
        </style>
    </head>
    <body>
        <script>

function Map() {

    let that = this
    let self = {
        mapW: 32768,
        mapH: 32768,
        minX: -16000,
        maxX: 4000,
        minY: -8000,
        maxY: 12000,
        minZ: 0,
        maxZ: 6,
        zeroX: 16384,
        zeroY: 16384,
        tileSize: 1024,
        tileSets: [
            "dupzor,51",
            "yanis,6",
        ],
        tileSetRanges: {
            "dupzor,51": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  0], [ 1,  1]],
                2: [[ 0,  0], [ 2,  2]],
                3: [[ 0,  1], [ 4,  5]],
                4: [[ 0,  2], [ 9, 11]],
                5: [[ 0,  4], [19, 23]],
                6: [[ 0,  8], [38, 47]]
            },
            "yanis,6": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  0], [ 1,  1]],
                2: [[ 0,  0], [ 2,  2]],
                3: [[ 0,  1], [ 4,  5]],
                4: [[ 0,  2], [ 9, 11]],
                5: [[ 0,  4], [19, 23]],
                6: [[ 0,  8], [38, 47]]
            },
        },
        tileOverlayRanges: {
            "aiwe,1": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  0], [ 0,  0]],
                2: [[ 1,  1], [ 1,  1]],
                3: [[ 2,  3], [ 2,  3]],
                4: [[ 4,  6], [ 5,  6]],
                5: [[ 9, 12], [10, 13]],
                6: [[18, 25], [20, 27]]
            },
            "martipk,5": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  1], [ 0,  1]],
                2: [[ 1,  2], [ 1,  2]],
                3: [[ 3,  4], [ 3,  5]],
                4: [[ 6,  9], [ 7, 11]],
                5: [[12, 19], [15, 23]],
                6: [[24, 39], [31, 46]]
            },
            "rickrick,2": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  0], [ 1,  1]],
                2: [[ 1,  1], [ 2,  2]],
                3: [[ 3,  3], [ 4,  4]],
                4: [[ 7,  6], [ 9,  9]],
                5: [[14, 13], [18, 18]],
                6: [[28, 26], [36, 36]]
            },
            "vlad,1": {
                0: [[ 0,  0], [ 0,  0]],
                1: [[ 0,  1], [ 0,  1]],
                2: [[ 1,  2], [ 1,  2]],
                3: [[ 3,  4], [ 3,  4]],
                4: [[ 6,  9], [ 7,  9]],
                5: [[13, 18], [14, 19]],
                6: [[26, 37], [28, 39]]
            }
        },
        currentTileSet: "dupzor,51",
        currentTileOverlays: 0,
        x: null,
        y: null,
        z: null,
        l: null,
        targetX: 0,
        targetY: 0,
        targetZ: 0,
        isAnimating: false,
        isDragging: false,
        key: null,
        panAmount: 0.025,
        wheelAmount: 0.005,
        zoomAmount: 0.025,
        easeAmount: 0.2,
        landmarks: [],
        landmarksById: {},
        currentLandmarks: [],
        currentLandmarksIndexById: {},
        landmarkTypes: [
            "agriculture",
            "commercial",
            "entertainment",
            "government",
            "hotel",
            "industry",
            "monument",
            "public",
            "natural",
            "residential",
            "transportation"
        ],
        find: "",
        filter: "all",
        filterOptions: {
            "all": "all",
            "igNameConfirmed": "IG name confirmed",
            "igNameUnconfirmed": "IG name unconfirmed",
            "igNameUnknown": "IG name unknown",
            "igLatLngConfirmed": "IG latlng confirmed",
            "igLatLngUnconfirmed": "IG latlng unconfirmed",
            "igLatLngUnknown": "IG latlng unknown",
            "igWithPhoto": "with IG photo",
            "igWithoutPhoto": "without IG photo",
            "irlLandmarkConfirmed": "IRL landmark confirmed",
            "irlLandmarkUnconfirmed": "IRL landmark unconfirmed",
            "irlLandmarkUnknown": "IRL landmark unknown",
            "irlLatLngMissing": "IRL latlng missing",
            "irlWithPhoto": "with IRL photo",
            "irlWithoutPhoto": "without IRL photo",
            "mapIncluded": "included on the map",
            "mapNotIncluded": "not included on the map"
        },
        sort: "igAddress",
        sortOptions: {
            igAddress: "in-game address",
            igLatitude: "in-game latitude",
            igLongitude: "in-game longitude",
            irlAddress: "real-life address",
            irlLatitude: "real-life latitude",
            irlLongitude: "real-life longitude",
            tags: "tags",
            id: "id",
            edited: "last edited"
        },
        markers: {},
        focus: "map",
        defaults: {
            x: -4000,
            y: 2000,
            z: 1,
            l: null,
            find: "",
            filter: "all",
            sort: "igAddress",
            tileSet: "dupzor,51",
            tileOverlays: 0
        }
    }

    self.init = function() {

        self.getUserSettings()

        self.element = document.createElement("div")
        self.element.id = "map"
        self.canvas = document.createElement("canvas")
        self.canvas.id = "canvas"
        self.element.appendChild(self.canvas)
        self.context = self.canvas.getContext("2d")
        self.markersLayer = document.createElement("div")
        self.markersLayer.id = "markers"
        self.element.appendChild(self.markersLayer)
        document.body.appendChild(self.element)

        const zInt = Math.ceil(self.z)

        const overlayString = Object.keys(self.tileOverlayRanges).join(",")
        self.tiles = {}
        self.tilePaths = {}
        self.tileSets.forEach(function(tileSet, i) {
            self.tiles[tileSet] = {}
            self.tilePaths[tileSet] = {}
            ;[0, 1].forEach(function(overlay) {
                self.tiles[tileSet][overlay] = {}
                self.tilePaths[tileSet][overlay] = {}
                for (let z = self.minZ; z <= self.maxZ; z++) {
                    self.tiles[tileSet][overlay][z] = {}
                    self.tilePaths[tileSet][overlay][z] = {}
                    const [[x0, y0], [x1, y1]] = self.tileSetRanges[tileSet][z]
                    for (let y = y0; y <= y1; y++) {
                        self.tiles[tileSet][overlay][z][y] = {}
                        self.tilePaths[tileSet][overlay][z][y] = {}
                        for (let x = x0; x <= x1; x++) {
                            self.tiles[tileSet][overlay][z][y][x] = new Image()
                            self.tilePaths[tileSet][overlay][z][y][x] = tileSet
                            if (overlay == 1) {
                                Object.entries(self.tileOverlayRanges).forEach(function([name, ranges]) {
                                    if (
                                        x >= ranges[z][0][0] && x <= ranges[z][1][0] &&
                                        y >= ranges[z][0][1] && y <= ranges[z][1][1] && (
                                            [ranges[z][0][0], ranges[z][1][0]].includes(x) ||
                                            [ranges[z][0][1], ranges[z][1][1]].includes(y)
                                        )
                                    ) {
                                        self.tilePaths[tileSet][overlay][z][y][x] = `${tileSet},${overlayString}`
                                    } else if (
                                        x > ranges[z][0][0] && x < ranges[z][1][0] &&
                                        y > ranges[z][0][1] && y < ranges[z][1][1] &&
                                        self.tilePaths[tileSet][overlay][z][y][x] == tileSet
                                    ) {
                                        self.tilePaths[tileSet][overlay][z][y][x] = name
                                    }
                                })
                            }
                        }
                    }
                }
            })
        })

        self.markersLayer.addEventListener("click", self.onClick)
        window.addEventListener("hashchange", self.onHashchange)
        document.addEventListener("keydown", self.onKeydown)
        document.addEventListener("keyup", self.onKeyup)
        self.markersLayer.addEventListener('mousedown',self.onMousedown)
        window.addEventListener("resize", self.onResize)
        self.markersLayer.addEventListener("wheel", self.onWheel, {passive: false})

        self.onResize(false)

        self.loadJSON("data/landmarks.json").then(self.initLandmarks)

        return that

    }

    self.initLandmarks = function(data) {

        self.landmarks = data.map(function(item) {
            return {
                "id": item[0],
                "idSortString": self.getIdSortString(item[0]),
                "igAddress": item[1],
                "igAddressSortString": self.getAddressSortString(item[1]),
                "igCoordinates": item[2].length ? item[2] : null,
                "igPhoto": item[3],
                "irlAddress": item[4].replace(/(?<=.)\?$/, ""),
                "irlAddressSortString": self.getAddressSortString(item[4].replace(/(?<=.)\?$/, "")),
                "irlCoordinates": item[5].length ? item[5] : null,
                "irlStatus": item[4] == "?" ? "unknown" : item[4].slice(-1) == "?" ? "unconfirmed" : "confirmed",
                "irlPhoto": item[6],
                "tags": item[7],
                "color": item[8],
                "borderColor": [0, 1, 2].map(function(i) {
                    const dec = Number("0x" + item[8].slice(i * 2, (i + 1) * 2))
                    return (dec + 64).toString(16)
                }).join(""),
                "edited": item[9],
                "findString": item[0] + "\n" + item[1].toLowerCase() + "\n" + item[4].toLowerCase()
            }
        })
        self.landmarks.forEach(function(landmark) {
            landmark.igNameAndAddress = self.getLandmarkNameAndAddress(landmark.igAddress)
            landmark.irlNameAndAddress = self.getLandmarkNameAndAddress(landmark.irlAddress)
            landmark.title = self.getLandmarkTitle(landmark)
        })
        self.landmarksById = self.landmarks.reduce(function(a, v) {
            a[v.id] = v
            return a
        }, {})
        self.currentLandmarks = self.landmarks.slice()

        self.markers = {}
        self.landmarks.filter(function(landmark) {
            return landmark.igCoordinates !== null
        }).sort(function(a, b) {
            return b.igCoordinates[1] - a.igCoordinates[1]
        }).forEach(function(landmark) {
            self.markers[landmark.id] = document.createElement("div")
            self.markers[landmark.id].id = "marker_" + landmark.id
            self.markers[landmark.id].className = "marker"
            self.markers[landmark.id].style.backgroundColor = "#" + landmark.color 
            self.markers[landmark.id].title = landmark.title
            self.markersLayer.appendChild(self.markers[landmark.id])
        })

        self.listPanel = document.createElement("div")
        self.listPanel.className = "panel"
        self.listPanel.id = "listPanel"
        self.element.appendChild(self.listPanel)

        self.titleBar = document.createElement("div")
        self.titleBar.id = "titleBar"
        self.listPanel.appendChild(self.titleBar)

        self.titleElement = document.createElement("div")
        self.titleElement.id = "titleElement"
        self.titleElement.innerHTML = "GTA VI LANDMARKS MAP"
        self.titleBar.appendChild(self.titleElement)

        self.aboutButton = document.createElement("div")
        self.aboutButton.className = "aboutButton"
        self.aboutButton.innerHTML = "ABOUT"
        self.aboutButton.addEventListener("click", function() {
            self.openAboutDialog()
        })
        self.titleBar.appendChild(self.aboutButton)

        self.findBar = document.createElement("div")
        self.findBar.id = "findBar"
        self.listPanel.appendChild(self.findBar)

        self.findElement = document.createElement("input")
        self.findElement.type = "text"
        self.findElement.value = self.find
        self.findElement.placeholder = "FIND"
        self.findElement.spellcheck = false
        self.findElement.addEventListener("change", function(e) {
            self.findElement.blur()
            setTimeout(function() {
                // allow for clear button
                self.findAndFilterLandmarks(self.findElement.value, self.filter)
            })
        })
        self.findElement.addEventListener("input", function(e) {
            self.clearFindButton.style.display = self.findElement.value ? "block" : "none"
        })
        self.findBar.appendChild(self.findElement)

        self.clearFindButton = document.createElement("div")
        self.clearFindButton.className = "clearButton"
        self.clearFindButton.innerHTML = "CLEAR"
        self.clearFindButton.style.display = self.find ? "block" : "none"
        self.clearFindButton.addEventListener("mousedown", function() {
            self.findElement.value = ""
            self.findAndFilterLandmarks("", self.filter)
            self.clearFindButton.style.display = "none"
        })
        self.findBar.appendChild(self.clearFindButton)

        self.filterBar = document.createElement("div")
        self.filterBar.id = "filterBar"
        self.listPanel.appendChild(self.filterBar)

        self.filterElement = document.createElement("select")
        Object.entries(self.filterOptions).forEach(function([key, value]) {
            const element = document.createElement("option")
            element.value = key
            element.textContent = ("Filter: " + value).toUpperCase()
            element.selected = key == self.filter
            self.filterElement.appendChild(element)
        })
        self.filterElement.value = self.filter
        self.filterElement.addEventListener("change", function() {
            this.blur()
            self.clearFilterButton.style.display = this.value == "all" ? "none" : "block"
            self.findAndFilterLandmarks(self.find, this.value)
        })
        self.filterBar.appendChild(self.filterElement)

        self.clearFilterButton = document.createElement("div")
        self.clearFilterButton.className = "clearButton"
        self.clearFilterButton.innerHTML = "CLEAR"
        self.clearFilterButton.style.display = self.filter == "all" ? "none" : "block"
        self.clearFilterButton.addEventListener("mousedown", function() {
            self.filterElement.value = "all"
            self.clearFilterButton.style.display = "none"
            self.findAndFilterLandmarks(self.find, "all")
        })
        self.filterBar.appendChild(self.clearFilterButton)

        self.sortBar = document.createElement("div")
        self.sortBar.id = "sortBar"
        self.sortBar.addEventListener("click", function(e) {
            if (e.target == self.sortBar) {
                self.listBody.scrollTo(0, 0)
            }
        })
        self.listPanel.appendChild(self.sortBar)

        self.sortElement = document.createElement("select")
        Object.entries(self.sortOptions).forEach(function([key, value]) {
            const element = document.createElement("option")
            element.value = key
            element.textContent = ("Sort by " + value).toUpperCase()
            element.selected = key == self.sort
            self.sortElement.appendChild(element)
        })
        self.sortElement.value = self.sort
        self.sortElement.addEventListener("change", function() {
            this.blur()
            self.sortLandmarks(this.value)
            self.renderList()
            if (self.l) {
                self.setLandmark(self.l)
            }
        })
        self.sortBar.appendChild(self.sortElement)

        self.listBody = document.createElement("div")
        self.listBody.id = "listBody"
        self.listPanel.appendChild(self.listBody)

        self.statusBar = document.createElement("div")
        self.statusBar.id = "statusBar"
        self.statusBar.addEventListener("click", function(e) {
            if (e.target == self.statusBar) {
                self.listBody.scrollTo(0, self.landmarks.length * 32)
            }
        })
        self.renderStatus()
        self.listPanel.appendChild(self.statusBar)

        self.itemPanel = document.createElement("div")
        self.itemPanel.className = "panel"
        self.itemPanel.id = "itemPanel"
        self.element.appendChild(self.itemPanel)

        self.itemBar = document.createElement("div")
        self.itemBar.id = "itemBar"
        self.itemPanel.appendChild(self.itemBar)

        self.itemId = document.createElement("div")
        self.itemId.id = "itemId"
        self.itemBar.appendChild(self.itemId)

        self.closeItemButton = document.createElement("div")
        self.closeItemButton.className = "closeButton"
        self.closeItemButton.innerHTML = "CLOSE"
        self.closeItemButton.addEventListener("mousedown", function() {
            self.setLandmark(null)
        })
        self.itemBar.appendChild(self.closeItemButton)

        self.itemBody = document.createElement("div")
        self.itemBody.id = "itemBody"
        self.itemPanel.appendChild(self.itemBody)

        self.itemIg = document.createElement("div")
        self.itemIg.id = "itemIg"
        self.itemBody.appendChild(self.itemIg)

        self.itemIgName = document.createElement("div")
        self.itemIgName.className = "name"
        self.itemIg.appendChild(self.itemIgName)

        self.itemIgAddress = document.createElement("div")
        self.itemIg.appendChild(self.itemIgAddress)

        self.itemIgCoordinates = document.createElement("div")
        self.itemIgCoordinates.className = "coordinates"
        self.itemIg.appendChild(self.itemIgCoordinates)

        self.itemIgPhoto = document.createElement("div")
        self.itemIgPhoto.className = "photo"
        self.itemBody.appendChild(self.itemIgPhoto)

        self.itemIrl = document.createElement("div")
        self.itemIrl.id = "itemIrl"
        self.itemBody.appendChild(self.itemIrl)

        self.itemIrlName = document.createElement("div")
        self.itemIrlName.className = "name"
        self.itemIrl.appendChild(self.itemIrlName)

        self.itemIrlAddress = document.createElement("div")
        self.itemIrl.appendChild(self.itemIrlAddress)

        self.itemIrlCoordinates = document.createElement("div")
        self.itemIrlCoordinates.className = "coordinates"
        self.itemIrl.appendChild(self.itemIrlCoordinates)

        self.itemIrlPhoto = document.createElement("div")
        self.itemIrlPhoto.className = "photo"
        self.itemBody.appendChild(self.itemIrlPhoto)

        self.itemTags = document.createElement("div")
        self.itemTags.id = "itemTags"
        self.itemBody.appendChild(self.itemTags)

        self.itemStatus = document.createElement("div")
        self.itemStatus.id = "itemStatus"
        self.itemBody.appendChild(self.itemStatus)

        self.itemEdited = document.createElement("div")
        self.itemEdited.id = "itemEdited"
        self.itemBody.appendChild(self.itemEdited)

        self.dialogLayer = document.createElement("div")
        self.dialogLayer.id = "dialogLayer"
        self.element.appendChild(self.dialogLayer)

        self.aboutDialog = document.createElement("div")
        self.aboutDialog.className = "dialog"
        self.aboutDialog.id = "aboutDialog"
        self.dialogLayer.appendChild(self.aboutDialog)

        self.aboutDialogBar = document.createElement("div")
        self.aboutDialogBar.className = "bar"
        self.aboutDialog.appendChild(self.aboutDialogBar)

        self.aboutDialogTitle = document.createElement("div")
        self.aboutDialogTitle.className = "title"
        self.aboutDialogTitle.innerHTML = "GTA VI Landmarks Map"
        self.aboutDialogBar.appendChild(self.aboutDialogTitle)

        self.aboutDialogButton = document.createElement("div")
        self.aboutDialogButton.className = "button"
        self.aboutDialogButton.innerHTML = "CLOSE"
        self.aboutDialogButton.addEventListener("click", function(e) {
            self.closeAboutDialog()
        })
        self.aboutDialogBar.appendChild(self.aboutDialogButton)

        self.aboutDialogContent = document.createElement("div")
        self.aboutDialogContent.className = "content"
        let img = document.createElement("img")
        img.src = "gta6map.png"
        self.aboutDialogContent.appendChild(img)
        self.aboutDialog.appendChild(self.aboutDialogContent)

        self.photoDialog = document.createElement("div")
        self.photoDialog.className = "dialog"
        self.photoDialog.id = "photoDialog"
        self.dialogLayer.appendChild(self.photoDialog)

        self.photoDialogBar = document.createElement("div")
        self.photoDialogBar.className = "bar"
        self.photoDialog.appendChild(self.photoDialogBar)

        self.photoDialogTitle = document.createElement("div")
        self.photoDialogTitle.className = "title"
        self.photoDialogBar.appendChild(self.photoDialogTitle)

        self.photoDialogButton = document.createElement("div")
        self.photoDialogButton.className = "button"
        self.photoDialogButton.innerHTML = "CLOSE"
        self.photoDialogButton.addEventListener("click", function(e) {
            self.closePhotoDialog()
        })
        self.photoDialogBar.appendChild(self.photoDialogButton)

        self.photoDialogContent = document.createElement("div")
        self.photoDialogContent.className = "content"
        self.photoDialog.appendChild(self.photoDialogContent)

        self.listPanel.addEventListener("mousedown", function(e) {
            self.focus = "list"
            if (e.target.parentElement.classList.contains("item")) {
                const id = e.target.parentElement.id.replace("item_", "")
                if (e.metaKey && e.target.parentElement.classList.contains("selected")) {
                    self.setLandmark(null)
                } else {
                    self.setLandmark(id, true)
                }
            }
        })

        //self.findAndFilterLandmarks(self.find, self.filter)
        //self.sortLandmarks(self.sort)
        //self.renderList()
        self.onHashchange()

    }

    self.animate = function(immediate=false) {
        if (!immediate) {
            self.isAnimating = true
        }
        const dx = self.targetX - self.x
        const dy = self.targetY - self.y
        const dz = self.targetZ - self.z
        easeAmount = immediate ? 1 : self.easeAmount
        self.x += easeAmount * dx
        self.y += easeAmount * dy
        self.z += easeAmount * dz
        self.renderMap()
        if (!immediate) {
            if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1 || Math.abs(dz) > 0.01) {
                requestAnimationFrame(function() {
                    self.animate()
                })
            } else {
                self.x = self.targetX
                self.y = self.targetY
                self.z = self.targetZ
                self.isAnimating = false
                self.renderMap() // FIXME
                self.setHash()
            }
        }
    }

    self.checkValues = function(v) {
        v.x = isNaN(v.x) ? 0 : self.clamp(v.x, self.minX, self.maxX)
        v.y = isNaN(v.y) ? 0 : self.clamp(v.y, self.minY, self.maxY)
        v.z = isNaN(v.z) ? 0 : self.clamp(v.z, self.minZ, self.maxZ)
        v.l = self.landmarksById[v.l] ? v.l : self.defaults.l
        v.filter = self.filterOptions[v.filter] ? v.filter : self.defaults.filter
        v.sort = self.sortOptions[v.sort] ? v.sort : self.defaults.sort
        v.tileSet = self.tileSets.includes(v.tileSet) ? v.tileSet : self.defaults.tileSet
        v.tileOverlays = v.tileOverlays ? 1 : 0
        return v
    }

    self.clamp = function(n, min, max) {
        return Math.min(Math.max(n, min), max)
    }

    self.findAndFilterLandmarks = function(find, filter) {
        self.find = find.toLowerCase()
        self.filter = filter
        self.setUserSettings()
        self.currentLandmarks = self.landmarks.filter(function(landmark) {
            return landmark.findString.includes(self.find) && (
                self.filter == "all" ||
                self.filter == "igNameConfirmed" && !landmark.igAddress.includes("?") && landmark.igAddress[0] != '"' ||
                self.filter == "igNameUnconfirmed" && landmark.igAddress.includes("?") && landmark.igAddress[0] != "?" ||
                self.filter == "igNameUnknown" && (landmark.igAddress[0] == "?" || landmark.igAddress[0] == '"') ||
                self.filter == "igLatLngConfirmed" && landmark.igAddress.slice(-1) != "?" && landmark.igCoordinates !== null ||
                self.filter == "igLatLngUnconfirmed" && landmark.igAddress.slice(-1) == "?" ||
                self.filter == "igLatLngUnknown" && landmark.igCoordinates === null ||
                self.filter == "igWithPhoto" && landmark.igPhoto ||
                self.filter == "igWithoutPhoto" && !landmark.igPhoto ||
                self.filter == "irlLandmarkConfirmed" && landmark.irlStatus == "confirmed" ||
                self.filter == "irlLandmarkUnconfirmed" && landmark.irlStatus == "unconfirmed" ||
                self.filter == "irlLandmarkUnknown" && landmark.irlStatus == "unknown" ||
                self.filter == "irlLatLngMissing" && landmark.irlAddress[0] != "?" && landmark.irlCoordinates === null ||
                self.filter == "irlWithPhoto" && landmark.irlPhoto ||
                self.filter == "irlWithoutPhoto" && !landmark.irlPhoto ||
                self.filter == "mapIncluded" && landmark.id[0] == "b" ||
                self.filter == "mapNotIncluded" && landmark.id[0] == "x"
            )
        })
        // FIXME: duplicated
        self.currentLandmarksIndexById = self.currentLandmarks.reduce(function(a, v, i) {
            a[v.id] = i
            return a
        }, {})
        if (self.l && self.currentLandmarksIndexById[self.l] == void 0) {
            self.l = null
        }
        self.clearMarkers()
        self.renderMarkers()
        self.sortLandmarks(self.sort) // update indexById 
        self.renderList()
        self.renderStatus()
        self.setLandmark(self.l) // scroll into view. calls renderItem
    }

    self.formatAddress = function(address) {
        address = address || "?"
        if (!"0123456789?".includes(address[0])) {
            const parts = address.split(", ")
            const comma = parts.length == 1 ? "" : ", "
            return `<span style="font-weight: bold">${parts[0]}</span>${comma}${parts.slice(1).join(", ")}`
        }
        return address
    }

    self.formatCoordinates = function(coordinates) {
        return coordinates ? coordinates.join(",") : "?"
    }

    self.formatDate = function(timestamp) {
        return new Date(timestamp * 1000).toISOString().slice(0, -5).replace("T", " ") + " UTC"
    }

    self.getAddressSortString = function(address) {
        let parts = address.replace(/\?/g, "ZZZ").split(", ")
        parts.forEach(function(part, p) {
            let words = part.split(" ")
            words.forEach(function(word, w) {
                if (/^\d+$/.test(word)) {
                    words[w] = "0".repeat(10 - word.length) + word
                }
            })
            if (/^\d+$/.test(words[0])) {
                words = words.slice(1).concat(words[0])
            }
            parts[p] = words.join(" ")
        })
        return parts.reverse().join("\n") // newline since we want "Ambrosia" before "Ambrosia County"
    }

    self.getIdSortString = function(id) {
        return id[0] + "0".repeat(10 - id.length) + id.slice(1)
    }

    self.getLandmarkNameAndAddress = function(address) {
        const parts = address.split(", ")
        if ("0123456789".includes(address[0])) {
            return [parts[0], address]
        }
        return [parts[0], parts.slice(1).join(", ")]
    }

    self.getLandmarkTitle = function(landmark) {
        return landmark.igAddress.split(", ")[0] + "\n" + landmark.irlAddress.split(", ")[0]
    }

    self.getMppx = function(z=self.z) {
        return self.mapW / (1024 * Math.pow(2, z))
    }

    self.getUserSettings = function() {
        let data = localStorage.getItem("gta6map")
        let user
        if (!data) {
            user = self.defaults
        } else {
            user = self.checkValues(JSON.parse(localStorage.getItem("gta6map")).user)
        }
        for (const [key, value] of Object.entries(user)) {
            self[key] = value
        }
    }

    self.setUserSettings = function() {
        localStorage.setItem("gta6map", JSON.stringify({"user": {
            x: self.x,
            y: self.y,
            z: self.z,
            l: self.l,
            find: self.find,
            filter: self.filter,
            sort: self.sort,
            tileSet: self.tileSet,
            tileOverlays: self.tileOverlays
        }}))
    }

    self.loadJSON = async function(url) {
        try {
            const req = await fetch(url, {cache: "no-cache"})
            if (!req.ok) {
                throw new Error(req.status)
            }
            return await req.json()
        } catch (err) {
            throw err
        }
    }

    self.loadPhoto = function(src, width, ratioCallback, loadCallback) {
        let img = document.createElement("img")
        const interval = setInterval(function() {
            if (img.naturalWidth) {
                ratioCallback(img.naturalWidth / img.naturalHeight)
                clearInterval(interval)
            }
        }, 25)
        img.onload = function() {
            const ratio = img.naturalWidth / img.naturalHeight
            img.style.width = width
            img.style.height = width / ratio
            loadCallback(img)
        }
        img.src = src
    }

    self.onHashchange = function() {
        let values = window.location.hash.slice(1).split(",")
        if (values.length > 4) {
            values[3] = values.slice(3).join(",")
        }
        let last = values[values.length - 1]
        let l, lx, ly, lz, f
        if (isNaN(last)) {
            if (self.landmarksById[last]) {
                l = last
                if (self.landmarksById[last].igCoordinates) {
                    lx = self.landmarksById[last].igCoordinates[0]
                    ly = self.landmarksById[last].igCoordinates[1]
                    lz = 5
                } else {
                    lx = self.x
                    ly = self.y
                    lz = self.z
                }
            } else {
                last = last.toLowerCase()
                const landmarks = self.landmarks.filter(function(landmark) {
                    return landmark.findString.includes(last)
                })
                if (landmarks.length == 1) {
                    l = landmarks[0].id
                    if (landmarks[0].igCoordinates) {
                        lx = landmarks[0].igCoordinates[0]
                        ly = landmarks[0].igCoordinates[1]
                        lz = 5
                    } else {
                        lx = self.x
                        ly = self.y
                        lz = self.z
                    }
                } else {
                    f = last
                    if (f != self.find) {
                        // last part of hash is find query
                        self.findElement.value = f
                        self.clearFindButton.style.display = "block"
                        self.filterElement.value = "all"
                        self.clearFilterButton.style.display = "none"
                        self.findAndFilterLandmarks(last, "all") // this calls setLandmark, which calls setHash
                    }
                }
            }
        }
        if (l && self.currentLandmarksIndexById[l] === void 0) {
            // selected landmark is not in current find & filter
            self.find = ""
            self.findElement.value = ""
            self.clearFindButton.style.display = "none"
            self.filter = "all"
            self.filterElement.value = "all"
            self.clearFilterButton.style.display = "none"
            self.findAndFilterLandmarks("", "all") // this calls setLandmark, which calls setHash
        }
        if (l || f || values.length == 4) {
            values = values.slice(0, -1)
        }
        values = values.map(parseFloat)
        if (values.length == 0) {
            values = l ? [lx, ly, lz] : [self.x, self.y, self.z]
        } else if (values.length == 1) {
            values = l ? [lx, ly, values[0]] : [self.x, self.y, values[0]]
        } else if (values.length == 2) {
            values = [values[0], values[1], self.z]
        }
        const hash = values.map(function(v, i) {
            const value = [self.x, self.y, self.z][i]
            const minV = [self.minX, self.minY, self.minZ][i]
            const maxV = [self.maxX, self.maxY, self.maxZ][i]
            v = isNaN(v) ? value : self.clamp(v, minV, maxV)
            return v.toFixed(3)
        }).join(",") + (l ? "," + l : "")
        if (hash != window.location.hash.substr(1)) {
            window.location.hash = hash
            return
        }
        //;[self.x, self.y, self.z] = values
        //self.l = l || self.l
        //self.setUserSettings()
        ;[self.targetX, self.targetY, self.targetZ] = values
        self.l = l
        self.findAndFilterLandmarks(self.find, self.filter)
        self.selectLandmark(l) // this calls setHash!
        if (!self.isAnimating) {
            self.animate()
        }
    }

    self.onKeydown = function(e) {

        const activeElement = document.activeElement
        if (activeElement.tagName == "INPUT") {
            return
        }

        if (["t", "T"].includes(e.key) && !e.metaKey) {
            if (e.key == "t") {
                self.tileSet = self.tileSet == self.tileSets[0] ? self.tileSets[1] : self.tileSets[0]
            } else {
                self.tileOverlays = 1 - self.tileOverlays
            }
            self.setUserSettings()
            self.renderMap()
        }

        if (self.focus == "map") {

            if (["0", "1", "2", "3", "4", "5", "6"].includes(e.key)) {
                self.setTarget(self.targetX, self.targetY, parseInt(e.key))
            } else if (["-", "=", "ArrowDown", "ArrowLeft", "ArrowRight", "ArrowUp"].includes(e.key)) {
                if (self.keydownTimeout) {
                    clearTimeout(self.keydownTimeout)
                    self.keydownTimeout = null
                }
                (function keydownFn() {
                    if (e.key == "-") {
                        self.setTarget(self.targetX, self.targetY, self.targetZ - self.zoomAmount)
                    } else if (e.key == "=") {
                        self.setTarget(self.targetX, self.targetY, self.targetZ + self.zoomAmount)
                    } else if (e.key == "ArrowDown") {
                        self.setTarget(self.targetX, self.targetY - self.getMppx() * canvas.height * self.panAmount, self.targetZ)
                    } else if (e.key == "ArrowLeft") {
                        self.setTarget(self.targetX - self.getMppx() * canvas.height * self.panAmount, self.targetY, self.targetZ)
                    } else if (e.key == "ArrowRight") {
                        self.setTarget(self.targetX + self.getMppx() * canvas.height * self.panAmount, self.targetY, self.targetZ)
                    } else if (e.key == "ArrowUp") {
                        self.setTarget(self.targetX, self.targetY + self.getMppx() * canvas.height * self.panAmount, self.targetZ)
                    }
                    self.keydownTimeout = setTimeout(keydownFn)
                }())
            } else if (e.key == "Escape") {
                if (self.l) {
                    self.setLandmark(null)
                }
            }

        } else if (self.focus == "list") {

            if (self.l === null) {
                return
            }
            if (["ArrowDown", "ArrowLeft", "ArrowRight", "ArrowUp"].includes(e.key)) {
                e.preventDefault()
                const index = self.currentLandmarksIndexById[self.l]
                let id = self.l
                if (e.key == "ArrowDown") {
                    if (index < self.currentLandmarks.length - 1) {
                        id = self.currentLandmarks[index + 1].id
                        self.setLandmark(id, true)
                    }
                } else if (e.key == "ArrowLeft") {
                    if (index > 0) {
                        id = self.currentLandmarks[0].id
                        self.setLandmark(id, true)
                    }
                } else if (e.key == "ArrowRight") {
                    if (index < self.currentLandmarks.length - 1) {
                        id = self.currentLandmarks[self.currentLandmarks.length - 1].id
                        self.setLandmark(id, true)
                    }
                } else if (e.key == "ArrowUp") {
                    if (index > 0) {
                        id = self.currentLandmarks[index - 1].id
                        self.setLandmark(id, true)
                    }
                }
            } else if (e.key == "Escape") {
                if (self.l) {
                    self.setLandmark(null)
                }
            }

        } else if (self.focus == "dialog") {

            if (self.aboutDialog.style.display == "block") {
                if (e.key == "Escape") {
                    self.closeAboutDialog()
                }
            } else {
                if (e.key == "ArrowLeft" || e.key == "ArrowRight") {
                    self.switchPhotoDialog()
                } else if (e.key == "Escape") {
                    self.closePhotoDialog()
                }
            }

        }

    }

    self.onKeyup = function(e) {
        const activeElement = document.activeElement
        if (activeElement.tagName == "INPUT") {
            return
        }
        if (self.keydownTimeout) {
            clearTimeout(self.keydownTimeout)
            self.keydownTimeout = null
        }
    }

    self.onMousedown = function(e) {
        e.preventDefault()
        self.focus = "map"
        if (e.target.classList.contains("marker")) {
            const id = e.target.id.replace("marker_", "")
            if (e.target.classList.contains("selected") && e.metaKey) {
                self.setLandmark(null)
            } else if (!e.target.classList.contains("selected")) {
                self.setLandmark(id)
            }
            return
        }
        self.isDragging = false
        const clientX = e.clientX
        const clientY = e.clientY
        const [originalX, originalY, originalZ] = [self.targetX, self.targetY, self.targetZ]
        const mppx = self.getMppx()
        function onMousemove(e) {
            if (!self.isDragging) {
                self.isDragging = true
                self.element.classList.add("dragging")
            }
            self.setTarget(
                originalX - mppx * (e.clientX - clientX),
                originalY + mppx * (e.clientY - clientY),
                originalZ,
                true
            )
        }
        function onMouseup(e) {
            if (self.mouseTimeout) {
                clearTimeout(self.mouseTimeout)
                self.mouseTimeout = null
                const x = originalX + mppx * (clientX - canvas.width / 2)
                const y = originalY - mppx * (clientY - canvas.height / 2)
                self.setTarget(x, y, originalZ)
                navigator.clipboard.writeText(Math.round(x) + "," + Math.round(y))
            } else if (self.isDragging) {
                self.isDragging = false
                self.element.classList.remove("dragging")
                self.setHash()
            }
            document.removeEventListener("mousemove", onMousemove)
            document.removeEventListener("mouseup", onMouseup)
        }
        self.mouseTimeout = setTimeout(function() {
            document.addEventListener("mousemove", onMousemove)
            self.mouseTimeout = null
        }, 250)
        document.addEventListener("mouseup", onMouseup)
    }

    self.onResize = function(render=true) {
        canvas.width = window.innerWidth
        canvas.height = window.innerHeight
        canvas.style.width = window.innerWidth + "px"
        canvas.style.height = window.innerHeight + "px"
        if (render) {
            self.renderMap()
        }
        if (self.focus == "dialog") {
            self.resizePhotoDialog()
        }
    }

    self.onWheel = function(e) {
        e.preventDefault()
        if (self.wheelTimeout) {
            clearTimeout(self.wheelTimeout)
            self.wheelTimeout = null
        }
        const targetZ = self.clamp(self.z - e.deltaY * self.wheelAmount, self.minZ, self.maxZ)
        const mppx = self.getMppx()
        const targetMppx = self.getMppx(targetZ)
        const offsetX = e.clientX - canvas.width / 2
        const offsetY = e.clientY - canvas.height / 2
        self.setTarget(
            self.x + mppx * offsetX - targetMppx * offsetX,
            self.y - mppx * offsetY + targetMppx * offsetY,
            targetZ,
            true
        )
        self.wheelTimeout = setTimeout(function() {
            self.setHash()
        }, 100)
    }

    self.openAboutDialog = function() {
        self.dialogLayer.style.display = "flex"
        self.aboutDialog.style.display = "block"
        self.focus = "dialog"
    }

    self.closeAboutDialog = function() {
        self.dialogLayer.style.display = "none"
        self.aboutDialog.style.display = "none"
        self.focus = "list"
    }

    self.openPhotoDialog = function(landmark, selected) {
        self.selectedPhoto = [landmark, selected]
        self.dialogPhoto = document.createElement("img")
        self.dialogPhoto.src = `photos/${landmark.id},${selected}.jpg`
        self.dialogPhoto.id = "dialogPhoto"
        self.photoDialogTitle.innerHTML = selected == "ig" ? landmark.igAddress : landmark.irlAddress
        self.photoDialogContent.innerHTML = ""
        self.photoDialogContent.appendChild(self.dialogPhoto)
        self.resizePhotoDialog()
        self.dialogLayer.style.display = "flex"
        self.photoDialog.style.display = "block"
        self.focus = "dialog"
    }

    self.switchPhotoDialog = function() {
        self.openPhotoDialog(self.selectedPhoto[0], self.selectedPhoto[1] == "ig" ? "irl" : "ig")
    }

    self.resizePhotoDialog = function() {
        const margin = 64
        const windowRatio = (window.innerWidth - margin) / (window.innerHeight - margin)
        const dialogRatio = self.dialogPhoto.naturalWidth / (self.dialogPhoto.naturalHeight + 32)
        let dialogWidth, dialogHeight
        if (dialogRatio >= windowRatio) {
            dialogWidth = window.innerWidth - margin
            dialogHeight = dialogWidth / dialogRatio
        } else {
            dialogHeight = window.innerHeight - margin
            dialogWidth = dialogHeight * dialogRatio
        }
        self.photoDialog.style.width = dialogWidth + "px"
        self.photoDialog.style.height = dialogHeight + "px"
        self.photoDialogBar.style.width = dialogWidth + "px"
        self.photoDialogTitle.style.width = dialogWidth - 80 + "px"
        self.photoDialogContent.style.width = dialogWidth + "px"
        self.photoDialogContent.style.height = dialogHeight - 32 + "px"
        self.dialogPhoto.style.width = dialogWidth + "px"
        self.dialogPhoto.style.height = dialogHeight - 32 + "px"
    }

    self.closePhotoDialog = function() {
        self.dialogLayer.style.display = "none"
        self.photoDialog.style.display = "none"
        self.focus = "list"
    }

    self.renderItem = function() {
        if (self.l) {
            landmark = self.landmarksById[self.l]
            self.itemId.innerHTML = ""
            let link = document.createElement("a")
            link.href = "#" + landmark.id
            link.innerHTML = landmark.id.toUpperCase()
            self.itemId.appendChild(link)
            self.itemIg.style.borderRightColor = "#" + landmark.color
            self.itemIgName.innerHTML = landmark.igNameAndAddress[0]
            self.itemIgAddress.innerHTML = landmark.igNameAndAddress[1]
            self.itemIgCoordinates.innerHTML = ""
            link = document.createElement("span")
            link.innerHTML = landmark.igCoordinates ? landmark.igCoordinates.join(",") : "?"
            if (landmark.igCoordinates) {
                link.classList.add("link")
                link.addEventListener("mousedown", function() {
                    self.setTarget(
                        landmark.igCoordinates[0],
                        landmark.igCoordinates[1],
                        self.z
                    )
                })
            }
            self.itemIgCoordinates.appendChild(link)
            self.itemIgPhoto.innerHTML = ""
            if (landmark.igPhoto) {
                self.loadPhoto(`photos/${landmark.id},ig.jpg`, 256, function(ratio) {
                    landmark.igPhotoRatio = ratio
                    self.itemIgPhoto.style.height = 256 / ratio + "px"
                }, function(img) {
                    img.addEventListener("click", function() {
                        self.openPhotoDialog(landmark, "ig")
                    })
                    self.itemIgPhoto.innerHTML = ""
                    self.itemIgPhoto.appendChild(img)
                })
            } else {
                self.itemIgPhoto.style.height = "144px"
            }
            self.itemIrl.style.borderRightColor = "#" + landmark.color
            self.itemIrlName.innerHTML = landmark.irlNameAndAddress[0] || "?"
            self.itemIrlAddress.innerHTML = landmark.irlNameAndAddress[1] || "?"
            self.itemIrlCoordinates.innerHTML = ""
            link = document.createElement(landmark.irlCoordinates ? "a" : "span")
            link.innerHTML = landmark.irlCoordinates ? landmark.irlCoordinates.join(",") : "?"
            if (landmark.irlCoordinates) {
                link.href = "https://google.com/maps/search/" + encodeURIComponent(landmark.irlAddress)
                link.target = "_blank"
            }
            self.itemIrlCoordinates.appendChild(link)
            self.itemTags.innerHTML = "TAGS: " + (
                landmark.tags.length ? landmark.tags : ["none"]
            ).map(function(tag) {
                return tag.toUpperCase()
            }).join(", ")
            self.itemStatus.innerHTML = `STATUS: ${landmark.irlStatus}`
            self.itemIrlPhoto.innerHTML = ""
            if (landmark.irlPhoto) {
                self.loadPhoto(`photos/${landmark.id},irl.jpg`, 256, function(ratio) {
                    landmark.irlPhotoRatio = ratio
                    self.itemIrlPhoto.style.height = 256 / ratio + "px"
                }, function(img) {
                    img.addEventListener("click", function() {
                        self.openPhotoDialog(landmark, "irl")
                    })
                    self.itemIrlPhoto.innerHTML = ""
                    self.itemIrlPhoto.appendChild(img)
                })
            } else {
                self.itemIrlPhoto.style.height = "144px"
            }
            self.itemEdited.innerHTML = "LAST EDITED: " + self.formatDate(landmark.edited)
            self.itemPanel.style.display = "block"
        } else {
            self.itemPanel.style.display = "none"
        }
    }

    self.renderList = function() {
        self.listBody.innerHTML = ""
        self.currentLandmarks.forEach(function(landmark) {
            const itemElement = document.createElement("div")
            itemElement.classList.add("item")
            if (landmark.id == self.l) {
                itemElement.classList.add("selected")
            }
            itemElement.id = "item_" + landmark.id
            itemElement.style.borderLeftColor = "#" + landmark.color
            const igElement = document.createElement("div")
            igElement.className = "ig"
            igElement.innerHTML = self.sort.includes("Address") ? landmark.igAddress
                    : landmark.igAddress + " &nbsp;|&nbsp; " + landmark.irlAddress
            itemElement.appendChild(igElement)
            const irlElement = document.createElement("div")
            irlElement.className = "irl"
            irlElement.innerHTML = self.sort.includes("Address") ? landmark.irlAddress
                    : self.sort.includes("igL") ? self.formatCoordinates(landmark.igCoordinates)
                    : self.sort.includes("irlL") ? self.formatCoordinates(landmark.irlCoordinates)
                    : self.sort == "tags" ? landmark.tags.join(", ").toUpperCase()
                    : self.formatDate(landmark.edited)
            itemElement.appendChild(irlElement)
            self.listBody.appendChild(itemElement)
        })
    }

    self.renderMap = function() {

        const zInt = Math.ceil(self.z)
        const mapSize = self.tileSize * Math.pow(2, self.z)
        const mppx = mapSize / self.mapW
        const cX = (self.x + self.zeroX) * mppx
        const cY = (self.zeroY - self.y) * mppx
        const offsetX = self.canvas.width / 2 - cX;
        const offsetY = self.canvas.height / 2 - cY;
        const tileSize = self.tileSize * Math.pow(2, self.z - zInt);

        const [[x0, y0], [x1, y1]] = self.tileSetRanges[self.tileSet][zInt]

        const minTx = Math.floor(-offsetX / tileSize)
        const maxTx = Math.ceil((self.canvas.width - offsetX) / tileSize)
        const minTy = Math.floor(-offsetY / tileSize)
        const maxTy = Math.ceil((self.canvas.height - offsetY) / tileSize)

        for (let y = minTy; y <= maxTy; y++) {
            for (let x = minTx; x <= maxTx; x++) {
                if (x >= x0 && x <= x1 && y >= y0 && y <= y1) {
                    const img = self.tiles[self.tileSet][self.tileOverlays][zInt][y][x]
                    if (!img.src) {
                        (function(originalX, originalY, originalZ) {
                            img.addEventListener("load", function() {
                                if (originalX == self.x && originalY == self.y && originalZ == self.z) {
                                    self.context.drawImage(
                                        img,
                                        offsetX + x * tileSize,
                                        offsetY + y * tileSize,
                                        tileSize,
                                        tileSize
                                    )
                                }
                            })
                        })(self.x, self.y, self.z)
                        const tilePath = self.tilePaths[self.tileSet][self.tileOverlays][zInt][y][x]
                        img.src = `tiles/${tilePath}/${zInt}/${zInt},${y},${x}.jpg`;
                    } else {
                        self.context.drawImage(
                            img,
                            offsetX + x * tileSize,
                            offsetY + y * tileSize,
                            tileSize,
                            tileSize
                        )
                    }
                } else {
                    self.context.clearRect(
                        offsetX + x * tileSize,
                        offsetY + y * tileSize,
                        tileSize,
                        tileSize
                    )
                }
            }
        }
        self.renderMarkers()

    }

    self.clearMarkers = function() {
        self.landmarks.filter(function(landmark) {
            return landmark.igCoordinates !== null
        }).forEach(function(landmark) {
            if (!self.currentLandmarks.includes(landmark)) {
                let marker = self.markers[landmark.id]
                marker.classList.remove("selected")
                marker.style.display = "none"
            }
        })
    }

    self.renderMarkers = function() {
        const left = -16
        const right = self.canvas.width + 16
        const top = -24
        const bottom = self.canvas.height + 24
        const mppx = self.getMppx()
        const minX = self.x - mppx * self.canvas.width / 2
        const maxY = self.y + mppx * self.canvas.height / 2
        self.currentLandmarks.filter(function(landmark) {
            return landmark.igCoordinates !== null
        }).forEach(function(landmark) {
            let markerElement = self.markers[landmark.id]
            const [x, y] = landmark.igCoordinates
            const screenX = (x - minX) / mppx
            const screenY = (maxY - y) / mppx
            if (screenX >= left && screenX <= right && screenY >= top && screenY <= bottom) {
                markerElement.style.left = screenX + "px"
                markerElement.style.top = screenY + "px"
                markerElement.style.display = "block"
            } else {
                markerElement.style.display = "none"
            }
        })
    }

    self.renderStatus = function() {
        self.statusBar.innerHTML = self.currentLandmarks.length + " LANDMARK" + (
            self.currentLandmarks.length == 1 ? "" : "S"
        )
    }

    self.selectLandmark = function(id) {
        self.l = id
        self.setUserSettings()
        let element = document.querySelector(".marker.selected")
        if (element) {
            element.classList.remove("selected")
        }
        if (self.l) {
            element = document.querySelector("#marker_" + self.l)
            if (element) {
                element.classList.add("selected")
            }
        }
        element = document.querySelector(".item.selected")
        if (element) {
            element.classList.remove("selected")
        }
        if (self.l) {
            element = document.querySelector("#item_" + self.l)
            if (element) {
                element.classList.add("selected")
                const top = 128, bottom = window.innerHeight - 64
                const y = element.getBoundingClientRect().y
                if (y < top) {
                    self.listBody.scrollTo(0, self.listBody.scrollTop + y - top)
                } else if (y > bottom) {
                    self.listBody.scrollTo (0, self.listBody.scrollTop + y - bottom)
                }
            }
        }
        self.renderItem()
    }

    self.setHash = function() {
        const hash = [self.targetX, self.targetY, self.targetZ].map(function (v) {
            return v.toFixed(3)
        }).join(",") + (self.l ? "," + self.l : "")
        if (window.location.hash.slice(1) != hash) {
            // history.replaceState(null, "", "#" + hash)
            window.location.hash = hash
        }
    }

    self.setLandmark = function(id, pan) {
        self.l = id
        if (pan) {
            const landmark = self.landmarksById[id]
            if (landmark.igCoordinates) {
                self.targetX = landmark.igCoordinates[0]
                self.targetY = landmark.igCoordinates[1]
                self.targetZ = self.z
            }
        }
        self.setHash()
        /*
        if (!self.isAnimating) {
            self.setHash()
        } else {
            let interval = setInterval(function() {
                if (!self.isAnimating) {
                    clearInterval(interval)
                    self.setHash()
                }
            }, 25)
        }
        */
    }

    self.setTarget = function(x, y, z, immediate=false) {
        x = self.clamp(x, self.minX, self.maxX)
        y = self.clamp(y, self.minY, self.maxY)
        z = self.clamp(z, self.minZ, self.maxZ)
        if (x != self.targetX || y != self.targetY || z != self.targetZ) {
            self.targetX = x
            self.targetY = y
            self.targetZ = z
            if (!self.isAnimating || immediate) {
                self.animate(immediate)
            }
        }
    }

    self.sortLandmarks = function(option) {
        self.sort = option
        self.setUserSettings()
        self.currentLandmarks.sort(function(a, b) {
            let sortValues = [a, b].map(function(v) {
                if (self.sort == "igAddress") {
                    return v.igAddressSortString + "\n" + v.irlAddressSortString
                } else if (self.sort == "igLatitude") {
                    return v.igCoordinates ? -v.igCoordinates[1] : 1e6
                } else if (self.sort == "igLongitude") {
                    return v.igCoordinates ? v.igCoordinates[0] : 1e6
                } else if (self.sort == "irlAddress") {
                    return v.irlAddressSortString + "\n" + v.igAddressSortString
                } else if (self.sort == "irlLatitude") {
                    return v.irlCoordinates ? -v.irlCoordinates[0] : 1e6
                } else if (self.sort == "irlLongitude") {
                    return v.irlCoordinates ? v.irlCoordinates[1] : 1e6
                } else if (self.sort == "tags") {
                    return [v.tags.join(", ")].concat(v.igAddress.split(", ").reverse()).join(", ")
                } else if (self.sort == "id") {
                    return v.idSortString
                } else if (self.sort == "edited") {
                    return -v.edited
                }
            })
            return sortValues[0] < sortValues[1] ? -1 : sortValues[0] > sortValues[1] ? 1 : 0
        })
        self.currentLandmarksIndexById = self.currentLandmarks.reduce(function(a, v, i) {
            a[v.id] = i
            return a
        }, {})
    }

    return self.init()

}

const map = Map()

        </script>
    </body>
</html>